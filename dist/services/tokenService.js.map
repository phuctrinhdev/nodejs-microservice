{"version":3,"sources":["../../build/services/tokenService.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","services_1","require","config_1","moment","jwt","TokenService","payload","role","option","exp","add","secret","config","server","encode","token","undefined","decode","errorService","auth","badToken","console","log","Date","getTime","now","tokenExpired","generateToken","employee_id","employeeService","getItem","filter","id","user","type","user_id","userService","database","queryFail","email","password_md5","password"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","file":"tokenService.js","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst services_1 = require(\"@/services\");\nconst config_1 = require(\"@/config\");\nconst moment = require(\"moment\");\nconst jwt = require(\"jwt-simple\");\nclass TokenService {\n    constructor() {\n    }\n    generateToken(payload, role, option = {\n        exp: moment().add(2, \"months\")\n    }) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const secret = option.secret || config_1.config.server.secret;\n            return jwt.encode({\n                payload: payload,\n                role: role,\n                exp: option.exp\n            }, secret);\n        });\n    }\n    decodeToken(token, option) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let result = undefined;\n            try {\n                const secret = (option && option.secret) || config_1.config.server.secret;\n                result = jwt.decode(token, secret);\n            }\n            catch (err) {\n                throw services_1.errorService.auth.badToken();\n            }\n            if (result) {\n                console.log(\"huhuigi \", (new Date(result.exp)).getTime());\n                console.log(\"huhuigi \", Date.now());\n                if ((new Date(result.exp)).getTime() <= (Date.now())) {\n                    throw services_1.errorService.auth.tokenExpired();\n                }\n                return result;\n            }\n            else {\n                throw services_1.errorService.auth.badToken();\n            }\n        });\n    }\n    getAdminToken(secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            return yield this.generateToken({}, \"admin\", {\n                exp: moment().add(1, 'days'),\n                secret\n            });\n        });\n    }\n    getWriteToken(secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            return yield this.generateToken({}, \"write\", {\n                exp: moment().add(1, 'days'),\n                secret\n            });\n        });\n    }\n    getReadToken(secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            return yield this.generateToken({}, \"read\", {\n                exp: moment().add(1, 'days'),\n                secret\n            });\n        });\n    }\n    // async getTokenAdmin(admin_id: string, secret: string = \"\") {\n    //     secret = secret + config.server.secret\n    //     let admin = await adminService.getItem({\n    //         filter: {\n    //             id: admin_id\n    //         }\n    //     });\n    //     return await this.generateToken({\n    //         admin_id,\n    //     }, undefined, {\n    //             exp: moment().add(2, 'months'),\n    //             secret\n    //         })\n    // }\n    getEmployeeToken(employee_id, secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            const user = yield services_1.employeeService.getItem({\n                filter: {\n                    id: employee_id\n                }\n            });\n            return yield this.generateToken({\n                employee_id,\n                role: user.type\n            }, user.type, {\n                exp: moment().add(2, 'months'),\n                secret\n            });\n        });\n    }\n    getUserToken(user_id, secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            const user = yield services_1.userService.getItem({\n                filter: {\n                    id: user_id\n                }\n            });\n            if (!user) {\n                throw services_1.errorService.database.queryFail(\"User not found to generate jwt token\");\n            }\n            return yield this.generateToken({\n                user_id,\n                role: 'USER'\n            }, 'USER', {\n                exp: moment().add(2, 'months'),\n                secret\n            });\n        });\n    }\n    getUserTokenForForgetPassWord(email, secret = \"\") {\n        return __awaiter(this, void 0, void 0, function* () {\n            secret = secret + config_1.config.server.secret;\n            const user = yield services_1.userService.getItem({\n                filter: {\n                    email\n                }\n            });\n            if (!user) {\n                throw services_1.errorService.database.queryFail(\"User not found to generate jwt token\");\n            }\n            return yield this.generateToken({\n                user_id: user.id,\n                password_md5: user.password,\n                role: 'USER'\n            }, 'USER', {\n                exp: moment().add(30, 'minutes'),\n                secret\n            });\n        });\n    }\n}\nexports.TokenService = TokenService;\n//# sourceMappingURL=tokenService.js.map"]}
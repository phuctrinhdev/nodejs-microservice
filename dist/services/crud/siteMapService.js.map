{"version":3,"sources":["../../../build/services/crud/siteMapService.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","crudService_pg_1","require","models_1","fs","convert","moment","SiteMapService","undefined","untrackedUrlsList","host","exec","Product","findAndCount","where","crawl_from","not_in_use","list_products_from_vivino","count","rows","forEach","element","push","slug","filterUniqueURLs","readFile","encoding","err","data","existingSitemapList","JSON","parse","xml2json","compact","spaces","existingSitemapURLStringList","urlset","url","length","map","ele","loc","_text","indexOf","changefreq","priority","lastmod","Date","format","createSitemapFile","finalXML","json2xml","saveNewSitemap","writeFile","console","log","CrudService"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","file":"siteMapService.js","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst crudService_pg_1 = require(\"../crudService.pg\");\nconst models_1 = require(\"@/models\");\nconst fs = require('fs');\nconst convert = require('xml-js');\nconst moment = require('moment');\nclass SiteMapService extends crudService_pg_1.CrudService {\n    constructor() {\n        super(undefined);\n        this.untrackedUrlsList = [];\n    }\n    createSiteMap() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const host = 'https://ritewine.com/';\n                const list_products_from_vivino = yield this.exec(models_1.Product.findAndCount({\n                    where: {\n                        crawl_from: 'VIVINO',\n                        not_in_use: false\n                    }\n                }));\n                if (list_products_from_vivino.count > 0) {\n                    list_products_from_vivino.rows.forEach((element) => {\n                        this.untrackedUrlsList.push(`${host}/wine/${element.slug}`);\n                    });\n                    yield this.filterUniqueURLs();\n                }\n            }\n            catch (error) {\n                throw error;\n            }\n        });\n    }\n    filterUniqueURLs() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                fs.readFile('./sitemap.xml', { encoding: 'utf8' }, (err, data) => __awaiter(this, void 0, void 0, function* () {\n                    if (err) {\n                        throw err;\n                    }\n                    if (data) {\n                        const existingSitemapList = JSON.parse(convert.xml2json(data, { compact: true, spaces: 4 }));\n                        let existingSitemapURLStringList = [];\n                        if (existingSitemapList.urlset && existingSitemapList.urlset.url && existingSitemapList.urlset.url.length) {\n                            existingSitemapURLStringList = existingSitemapList.urlset.url.map((ele) => ele.loc._text);\n                        }\n                        this.untrackedUrlsList.forEach((ele) => {\n                            if (existingSitemapURLStringList.indexOf(ele) == -1) {\n                                existingSitemapList.urlset.url.push({\n                                    loc: {\n                                        _text: ele,\n                                    },\n                                    changefreq: {\n                                        _text: 'monthly'\n                                    },\n                                    priority: {\n                                        _text: 0.8\n                                    },\n                                    lastmod: {\n                                        _text: moment(new Date()).format('YYYY-MM-DD')\n                                    }\n                                });\n                            }\n                        });\n                        yield this.createSitemapFile(existingSitemapList);\n                    }\n                }));\n            }\n            catch (error) {\n                throw error;\n            }\n        });\n    }\n    createSitemapFile(existingSitemapList) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const finalXML = convert.json2xml(existingSitemapList, { compact: true, spaces: 4 }); // to convert json text to xml text\n                this.saveNewSitemap(finalXML);\n            }\n            catch (error) {\n                throw error;\n            }\n        });\n    }\n    saveNewSitemap(finalXML) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                fs.writeFile('sitemap.xml', finalXML, (err) => {\n                    if (err) {\n                        console.log(err);\n                        throw err;\n                    }\n                    console.log(\"The file was saved!\");\n                });\n            }\n            catch (error) {\n                throw error;\n            }\n        });\n    }\n}\nexports.SiteMapService = SiteMapService;\n//# sourceMappingURL=siteMapService.js.map"]}